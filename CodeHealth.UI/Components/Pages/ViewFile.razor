@page "/project/{ProjectId}/file-view"
@inherits ViewFilePage

@using CodeHealth.UI.Components.Pages

@if (FileContent == null)
{
    <p>Loading file...</p>
}
else
{
    <div class="container-fluid">
        <div class="mb-3">
            <button class="btn btn-secondary mt-3" @onclick="NavigateBack">
                Back
            </button>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>@FileName</h5>
                @if (FileComplexities?.Any() == true)
                {
                    <div class="issue-legend">
                        <span class="badge high-complexity">High Complexity (CC > 20)</span>
                        <span class="badge medium-complexity">Medium Complexity (CC > 10)</span>
                        <span class="badge low-complexity">Low Complexity (CC ‚â§ 10)</span>
                        <span class="badge magic-number">Magic Numbers</span>
                    </div>
                }
            </div>
            <div class="card-body p-0">
                <div class="code-container">
                    <!-- fancy symbols for line-level indicators -->
                    <div class="gutter">
                        @for (int i = 1; i <= Lines.Length; i++)
                        {
                            var issues = GetIssuesForLine(i);
                            var hasHighCC = issues.Any(i => GetIssueClass(i) == "high-complexity");
                            var hasMediumCC = issues.Any(i => GetIssueClass(i) == "medium-complexity");
                            var hasLowCC = issues.Any(i => GetIssueClass(i) == "low-complexity");
                            var hasLongMethod = issues.Any(i => GetIssueClass(i) == "long-method");

                            <div class="line-container">
                                <div class="gutter-icon" title="@string.Join("\n", issues.Select(issue => $"{issue.Type}{(issue.Metric != null ? $": {issue.Metric.Name} {issue.Metric.Value}" : "")}"))">
                                    @if (hasHighCC) { <span class="icon high-complexity-icon">üî¥</span> }
                                    @if (hasMediumCC) { <span class="icon medium-complexity-icon">üü†</span> }
                                    @if (hasLowCC) { <span class="icon low-complexity-icon">üü¢</span> }
                                    @if (hasLongMethod) { <span class="icon long-method-icon">üìè</span> }
                                    @if (hasMagicNumber) { <span class="icon magic-number-icon">üî¢</span> }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Line Numbers -->
                    <div class="line-numbers">
                        @for (int i = 1; i <= Lines.Length; i++)
                        {
                            <div class="line-container">
                                <div class="line-number">@i</div>
                            </div>
                        }
                    </div>

                    <!-- Code Content -->
                    <pre class="code-content">
                        @foreach (var (line, index) in Lines.Select((line, idx) => (line, idx)))
                        {
                            var lineNumber = index + 1;
                            var issues = GetIssuesForLine(lineNumber);
                            var issueClasses = issues.Select(GetIssueClass).Where(c => !string.IsNullOrEmpty(c)).Distinct();
                            var hasMagicNumber = LineContainsMagicNumber(lineNumber, line);
                            
                            <div class="line-container">
                                <span class="@(issueClasses.Any() || hasMagicNumber ? string.Join(" ", issueClasses) + (hasMagicNumber ? " magic-number" : "") : "")">
                                    @line
                                </span>
                            </div>
                        }
                    </pre>
                </div>
            </div>
        </div>
    </div>
}